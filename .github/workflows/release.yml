name: Release

on:
    release:
        types: [published]

jobs:
    publish:
        runs-on: ubuntu-latest

        steps:
            - name: Harden the runner (Audit all outbound calls)
              uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
              with:
                  egress-policy: audit

            - name: Checkout repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
              with:
                  # This ensures we get the full history for proper versioning
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
              with:
                  node-version: "20.x"
                  cache: "npm"
                  registry-url: "https://registry.npmjs.org"

            - name: Install dependencies
              run: npm ci

            - name: Run type checking
              run: npm run type-check

            - name: Run linting
              run: npm run lint

            - name: Run tests
              run: npm test

            - name: Build project
              run: npm run build

            - name: Verify build artifacts
              run: |
                  # Verify all required files exist
                  ls -la dist/
                  test -f dist/bin/eslint-chunker.js
                  test -f dist/index.js
                  test -f dist/index.d.ts

                  # Test CLI functionality
                  node dist/bin/eslint-chunker.js --help
                  node dist/bin/eslint-chunker.js --version

            - name: Update package version
              run: |
                  # Extract version from release tag (remove 'v' prefix if present)
                  VERSION=${GITHUB_REF#refs/tags/}
                  VERSION=${VERSION#v}
                  echo "Publishing version: $VERSION"

                  # Update package.json version
                  npm version $VERSION --no-git-tag-version

            - name: Publish to npm
              run: npm publish --access public
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Create GitHub release comment
              uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const { owner, repo } = context.repo;
                      const release = context.payload.release;

                      const packageInfo = require('./package.json');
                      const version = packageInfo.version;

                      const comment = `ðŸš€ **Successfully published to npm!**

                      _Note: Package renamed from \`eslint-chunker\` to \`${packageInfo.name}\`. Legacy installs continue to work via bin aliases._

                      **Version:** \`${version}\`
                      **Package:** \`${packageInfo.name}\`
                      **Install:** \`npm install -g ${packageInfo.name}\`

                      **NPX Commands:**
                      - \`npx eslint-chunker\`
                      - \`npx chunkylint\`
                      - \`npx chunky-lint\`

                      **View on npm:** https://www.npmjs.com/package/${packageInfo.name}`;

                      await github.rest.issues.createComment({
                        owner,
                        repo,
                        issue_number: release.number,
                        body: comment
                      });
